<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://tbnpg.settlebank.co.kr/resources/js/v1/SettlePG_v1.2.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var today = new Date();

            var year = today.getFullYear(); // 년도
            var month = ('0' + (today.getMonth() + 1)).slice(-2); // 월
            // var date = ('0' + today.getDate()).slice(-2); // 날짜
            var date = ('0' + today.getDate()).slice(-2) - 10; // 날짜

            var formattedDate = year + '-' + month + '-' + date;
            document.querySelector("#startDate").value = formattedDate;

            const select = document.getElementById('productTypeSelect');
            select.addEventListener('change', function () {
                updateDataByProduct();
            });
        })


        const searchParams = new URLSearchParams(window.location.search);
        const agencyId = searchParams.get('agencyId');
        const mallId = searchParams.get('mallId');


        $.ajax({
            type       : 'POST',
            url        : "/agency/payment/info",
            contentType: "application/json",
            dataType   : "json",
            data       : JSON.stringify({agencyId: agencyId, mallId: mallId}),
            success    : function (response) {
                $("#paymentInfo").find("#paymentInfo_result").val(JSON.stringify(response));
                console.log(JSON.stringify(response));
                if (response.enumProductTypes) {
                    populateSelect(response.enumProductTypes);
                } else {
                    console.error('enumProductTypes is missing in the response');
                }
            },
            error      : function (xhr) {
                $("#paymentInfo").find("#paymentInfo_result").val(xhr.responseText);
                console.log(xhr.responseText);
            }
        })

        var basicOfferList = [];
        var basicPriceList = [];
        var productTypeList = [];

        function populateSelect(enumValues) {
            const select = document.getElementById('productTypeSelect');
            enumValues.forEach(enumValue => {
                const option = document.createElement('option');
                productTypeList.push(enumValue.type,enumValue.name,enumValue.price, enumValue.basicOffer);
                basicOfferList.push(enumValue.basicOffer);
                basicPriceList.push(enumValue.price);
                //
                option.textContent = `${enumValue.name} - ${parseInt(enumValue.price).toLocaleString()}원`;
                option.value = enumValue.type;
                option.name = option.textContent;

                select.appendChild(option);
            });
        }


        function updateDataByProduct() {
            const select = document.getElementById('productTypeSelect');
            const selectedValue = select.value;
            console.log("selectedValue : " + selectedValue)
            let offer;
            let price;


            const startDate = new Date(document.getElementById('startDate').value);
            let endDate = new Date(startDate);
            const lastDate = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0).getDate();

            const durations = lastDate - startDate.getDate();


            if (durations <= 15) {
                switch (selectedValue) {
                    case "lite_12m_2400" :
                        endDate.setFullYear(endDate.getFullYear() + 1);
                        endDate.setMonth(endDate.getMonth() + 1);
                        offer = (parseInt(basicOfferList[8]) * 12) + (parseInt(basicOfferList[8]) * durations / (lastDate));
                        price = ((basicPriceList[8] * durations / (lastDate)) + basicPriceList[8] * 11) * 1.1;
                        break;
                    case "basic_12m_12000" :
                        endDate.setFullYear(endDate.getFullYear() + 1);
                        endDate.setMonth(endDate.getMonth() + 1);
                        offer = (parseInt(basicOfferList[9]) * 12) + (parseInt(basicOfferList[9]) * durations / (lastDate));
                        price = ((basicPriceList[9] * durations / (lastDate)) + basicPriceList[9] * 11) * 1.1;
                        break;
                    case "standard_12m_24000" :
                        endDate.setFullYear(endDate.getFullYear() + 1);
                        endDate.setMonth(endDate.getMonth() + 1);
                        offer = (parseInt(basicOfferList[10]) * 12) + (parseInt(basicOfferList[10]) * durations / (lastDate));
                        price = ((basicPriceList[10] * durations / (lastDate)) + basicPriceList[10] * 11) * 1.1;
                        break;
                    case "premium_12m_36000" :
                        endDate.setFullYear(endDate.getFullYear() + 1);
                        endDate.setMonth(endDate.getMonth() + 1);
                        offer = (parseInt(basicOfferList[11]) * 12) + (parseInt(basicOfferList[11]) * durations / (lastDate));
                        price = ((basicPriceList[11] * durations / (lastDate)) + basicPriceList[11] * 11) * 1.1;
                        break;
                    case "lite_6m_1200" :
                        endDate.setMonth(endDate.getMonth() + 6 + 1);
                        offer = (parseInt(basicOfferList[8]) * 6) + (parseInt(basicOfferList[8]) * durations / (lastDate));
                        price = ((basicPriceList[8] * durations / (lastDate)) + basicPriceList[8] * 5) * 1.1;
                        break;
                    case "basic_6m_6000" :
                        endDate.setMonth(endDate.getMonth() + 6 + 1);
                        offer = (parseInt(basicOfferList[9]) * 6) + (parseInt(basicOfferList[9]) * durations / (lastDate));
                        price = ((basicPriceList[9] * durations / (lastDate)) + basicPriceList[9] * 5) * 1.1;
                        break;
                    case "standard_6m_12000" :
                        endDate.setMonth(endDate.getMonth() + 6 + 1);
                        offer = (parseInt(basicOfferList[10]) * 6) + (parseInt(basicOfferList[10]) * durations / (lastDate));
                        price = ((basicPriceList[10] * durations / (lastDate)) + basicPriceList[10] * 5) * 1.1;
                        break;
                    case "premium_6m_18000" :
                        endDate.setMonth(endDate.getMonth() + 6 + 1);
                        offer = (parseInt(basicOfferList[11]) * 6) + (parseInt(basicOfferList[11]) * durations / (lastDate));
                        price = ((basicPriceList[11] * durations / (lastDate)) + basicPriceList[11] * 5) * 1.1;
                        break;
                    case "lite_1m_200" :
                        endDate.setMonth(endDate.getMonth() + 1 + 1);
                        offer = parseInt(basicOfferList[8]) + parseInt(basicOfferList[8]) * durations / (lastDate);
                        price = ((basicPriceList[8] * durations / (lastDate)) + basicPriceList[8]) * 1.1;
                        break;
                    case "basic_1m_1000" :
                        endDate.setMonth(endDate.getMonth() + 1 + 1);
                        offer = parseInt(basicOfferList[9]) + parseInt(basicOfferList[9]) * durations / (lastDate);
                        price = ((basicPriceList[9] * durations / (lastDate)) + basicPriceList[9]) * 1.1;
                        break;
                    case "standard_1m_2000" :
                        endDate.setMonth(endDate.getMonth() + 1 + 1);
                        offer = parseInt(basicOfferList[10]) + parseInt(basicOfferList[10]) * durations / (lastDate);
                        price = ((basicPriceList[10] * durations / (lastDate)) + basicPriceList[10]) * 1.1;
                        break;
                    case "premium_1m_3000" :
                        endDate.setMonth(endDate.getMonth() + 1 + 1);
                        offer = parseInt(basicOfferList[11]) + parseInt(basicOfferList[11]) * durations / (lastDate);
                        price = ((basicPriceList[11] * durations / (lastDate)) + basicPriceList[11]) * 1.1;
                        break;
                }
            } else {
                switch (selectedValue) {
                    case "lite_12m_2400" :
                        endDate.setFullYear(endDate.getFullYear() + 1);
                        endDate.setMonth(endDate.getMonth());
                        offer = (parseInt(basicOfferList[8]) * 11) + (parseInt(basicOfferList[8]) * durations/(lastDate  ));
                        price = ((basicPriceList[8] * durations/(lastDate  ))+ basicPriceList[8] * 11) * 1.1;
                        break;
                    case "basic_12m_12000" :
                        endDate.setFullYear(endDate.getFullYear() + 1);
                        endDate.setMonth(endDate.getMonth());
                        offer = (parseInt(basicOfferList[9]) * 11) + (parseInt(basicOfferList[9]) * durations / (lastDate));
                        price = ((basicPriceList[9] * durations / (lastDate))+ basicPriceList[9]* 11) * 1.1;
                        break;
                    case "standard_12m_24000" :
                        endDate.setFullYear(endDate.getFullYear() + 1);
                        endDate.setMonth(endDate.getMonth());
                        offer = (parseInt(basicOfferList[10]) * 11) + (parseInt(basicOfferList[10]) * durations / (lastDate));
                        price = ((basicPriceList[10] * durations / (lastDate)) + basicPriceList[10] * 11) * 1.1;
                        break;
                    case "premium_12m_36000" :
                        endDate.setFullYear(endDate.getFullYear() + 1);
                        endDate.setMonth(endDate.getMonth());
                        offer = (parseInt(basicOfferList[11]) * 11) + (parseInt(basicOfferList[11]) * durations / (lastDate));
                        price = ((basicPriceList[11] * durations / (lastDate)) + basicPriceList[11] * 11) * 1.1;
                        break;
                    case "lite_6m_1200" :
                        endDate.setMonth(endDate.getMonth() + 5);
                        offer = (parseInt(basicOfferList[8]) * 5) + (parseInt(basicOfferList[8]) * durations / (lastDate));
                        price = ((basicPriceList[8] * durations / (lastDate)) + basicPriceList[8] * 5) * 1.1;
                        break;
                    case "basic_6m_6000" :
                        endDate.setMonth(endDate.getMonth() + 5);
                        offer = (parseInt(basicOfferList[9]) * 5) + (parseInt(basicOfferList[9]) * durations / (lastDate));
                        price = ((basicPriceList[9] * durations / (lastDate)) + basicPriceList[9] * 5) * 1.1;
                        break;
                    case "standard_6m_12000" :
                        endDate.setMonth(endDate.getMonth() + 5);
                        offer = (parseInt(basicOfferList[10]) * 5) + (parseInt(basicOfferList[10]) * durations / (lastDate));
                        price = ((basicPriceList[10] * durations / (lastDate)) + basicPriceList[10] * 5) * 1.1;
                        break;
                    case "premium_6m_18000" :
                        endDate.setMonth(endDate.getMonth() + 5);
                        offer = (parseInt(basicOfferList[11]) * 5) + (parseInt(basicOfferList[11]) * durations / (lastDate));
                        price = ((basicPriceList[11] * durations / (lastDate)) + basicPriceList[11] * 5) * 1.1;
                        break;
                    case "lite_1m_200" :
                        endDate.setMonth(endDate.getMonth());
                        offer = parseInt(basicOfferList[8]) * durations / (lastDate);
                        price = ((basicPriceList[8] * durations / (lastDate))) * 1.1;
                        break;
                    case "basic_1m_1000" :
                        endDate.setMonth(endDate.getMonth());
                        offer = parseInt(basicOfferList[9]) * durations / (lastDate);
                        price = ((basicPriceList[9] * durations / (lastDate))) * 1.1;
                        break;
                    case "standard_1m_2000" :
                        endDate.setMonth(endDate.getMonth());
                        offer = parseInt(basicOfferList[10]) * durations / (lastDate);
                        price = ((basicPriceList[10] * durations / (lastDate))) * 1.1;
                        break;
                    case "premium_1m_3000" :
                        endDate.setMonth(endDate.getMonth());
                        offer = parseInt(basicOfferList[11]) * durations / (lastDate);
                        price = ((basicPriceList[11] * durations / (lastDate))) * 1.1;
                        break;
                }
            }


            // Set date to the 0th day of the next month to get the last day of the current month
            endDate = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0);

            var year = endDate.getFullYear();
            var month = ('0' + (endDate.getMonth() + 1)).slice(-2);
            var date = ('0' + endDate.getDate()).slice(-2);

            var formattedEndDate = year + '-' + month + '-' + date;
            document.getElementById('endDate').value = formattedEndDate;
            document.getElementById('offer').value = Math.floor(offer);
            document.getElementById('price').value = Math.floor(price);
        }


        function result(data) {
            $.ajax({
                type       : "POST",
                url        : "http://127.0.0.1:9000/api/v1/hectoFinancial/result/decrypt",
                contentType: "application/json",
                dataType   : "json",
                data       : JSON.stringify({"data": data}),
                success    : function (res) {
                    console.log(res);
                    if (res.method === "vbank") {
                        $("#vbank_proc").find("#orgTrdNo").val(res.trdNo)
                        $("#vbank_proc").find("#cnclAmt").val(res.trdAmt)
                        $("#vbank_proc").find("#refundBankCd").val(res.fnCd)
                        $("#vbank_proc").find("#pay_result").val(JSON.stringify(res, null, 4))
                    } else {
                        $("#card_proc").find("#orgTrdNo").val(res.trdNo)
                        $("#card_proc").find("#cnclAmt").val(res.trdAmt)
                        $("#card_proc").find("#pay_result").val(JSON.stringify(res, null, 4))
                    }
                }
            })

            // var xhr = new XMLHttpRequest();
            // xhr.open("POST", "http://127.0.0.1:9000/api/v1/hectoFinancial/result/decrypt", false);
            // xhr.setRequestHeader("Content-Type","application/json");
            // xhr.send(JSON.stringify({data: data}))
        }

        function vbankCancel() {
            var mchtId = $("#mchtId").val();
            var orgTrdNo = $("#orgTrdNo").val();
            var cnclAmt = $("#cnclAmt").val();
            var refundBankCd = $("#refundBankCd").val();
            var refundAcntNo = $("#refundAcntNo").val();
            var refundDpstrNm = $("#refundDpstrNm").val();
            var data = {
                mchtId       : mchtId,
                orgTrdNo     : orgTrdNo,
                cnclAmt      : cnclAmt,
                refundBankCd : refundBankCd,
                refundAcntNo : refundAcntNo,
                refundDpstrNm: refundDpstrNm
            }
            $.ajax({
                type       : "POST",
                url        : "http://127.0.0.1:9000/api/v1/hectoFinancial/VBank/cancel",
                contentType: "application/json",
                dataType   : "json",
                data       : JSON.stringify(data),
                success    : function (res) {
                    $("#vbank_proc").find("#cancel_result").val(JSON.stringify(res, null, 4))
                }
            })
        }

        function cardCancel() {
            var mchtId = $("#card_proc").find("#mchtId").val();
            var orgTrdNo = $("#card_proc").find("#orgTrdNo").val();
            var cnclAmt = $("#card_proc").find("#cnclAmt").val();
            var data = {
                mchtId  : mchtId,
                orgTrdNo: orgTrdNo,
                cnclAmt : cnclAmt,
            }
            $.ajax({
                type       : "POST",
                url        : "http://127.0.0.1:9000/api/v1/hectoFinancial/billKey/cancel",
                contentType: "application/json",
                dataType   : "json",
                data       : JSON.stringify(data),
                success    : function (res) {
                    $("#card_proc").find("#cancel_result").val(JSON.stringify(res, null, 4))
                }
            })
        }


        function pay(type) {
            var curr_date = new Date();
            var year = curr_date.getFullYear().toString();
            var month = ("0" + (curr_date.getMonth() + 1)).slice(-2).toString();
            var day = ("0" + (curr_date.getDate())).slice(-2).toString();
            var hours = ("0" + curr_date.getHours()).slice(-2).toString();
            var mins = ("0" + curr_date.getMinutes()).slice(-2).toString();
            var secs = ("0" + curr_date.getSeconds()).slice(-2).toString();
            var random4 = ("000" + Math.random() * 10000).slice(-4).toString();

            // var custIp    = "127.0.0.1" // 세팅 필요
            var trdDt = year + month + day;
            var trdTm = hours + mins + secs;
            var mchtTrdNo = "PAYMENT" + year + month + day + hours + mins + secs + random4;//주문번호 세팅


            var method = type;

            var mchtId;
            if (type === "card") {
                mchtId = "nxca_jt_il"
            }
            // vbank
            else {
                mchtId = "nx_mid_il"
            }

            const select = document.getElementById('productTypeSelect');
            var selectedIndex = select.selectedIndex;
            var selectedOption = select.options[selectedIndex].text;


            var trdAmt = document.getElementById("price").value;
            var plainMchtCustNm = "홍길동"
            var plainEmail = "HongGilDong@example.com"
            var plainMchtCustId = "HongGilDong"
            var mchtName = "세틀뱅크"
            var mchtEName = "Settlebank"
            var pmtPrdtNm = selectedOption;


            var data = {
                mchtId              : mchtId,
                method              : method,
                mchtTrdNo           : mchtTrdNo,
                trdDt               : trdDt,
                trdTm               : trdTm,
                plainTrdAmt         : trdAmt,
                plainMchtCustNm     : plainMchtCustNm,
                plainCphoneNo       : "",
                plainEmail          : plainEmail,
                plainMchtCustId     : plainMchtCustId,
                plainTaxAmt         : "",
                plainVatAmt         : "",
                plainTaxFreeAmt     : "",
                plainSvcAmt         : "",
                plainClipCustNm     : "",
                plainClipCustCi     : "",
                plainClipCustPhoneNo: ""
            }

            $.ajax({
                type       : "POST",
                url        : "http://127.0.0.1:9000/api/v1/hectoFinancial/init/encrypt",
                contentType: "application/json",
                dataType   : "json",
                // data: $("#STPG_payForm").serialize(),
                data   : JSON.stringify(data),
                success: function (rsp) {
                    //암호화 된 파라미터 세팅
                    // for (name in rsp.encParams) {
                    //     $('#STPG_payForm [name=' + name + ']').val(rsp.encParams[name]);
                    // }
                    console.log("콘솔 메소드 확인용 : " + method)
                    //가맹점 -> 세틀뱅크로 결제 요청
                    SETTLE_PG.pay({
                        env       : "https://tbnpg.settlebank.co.kr",   //결제서버 URL
                        mchtId    : mchtId,
                        method    : method,
                        trdDt     : trdDt,
                        trdTm     : trdTm,
                        mchtTrdNo : mchtTrdNo,
                        mchtName  : mchtName,
                        mchtEName : mchtEName,
                        pmtPrdtNm : pmtPrdtNm,
                        trdAmt    : rsp.encParams.trdAmt,
                        mchtCustNm: rsp.encParams.mchtCustNm,
                        notiUrl   : "http://127.0.0.1:9000/api/v1/hectoFinancial/result/noti",
                        nextUrl   : "http://127.0.0.1:9000/api/v1/hectoFinancial/result/next",
                        cancUrl   : "https://example.com/cancUrl",
                        pktHash   : rsp.hashCipher,
                        ui        : {
                            type  : "popup",   //popup, iframe, self, blank
                            width : "430",   //popup창의 너비
                            height: "660"   //popup창의 높이
                        }
                    }, function (rsp) {
                        //iframe인 경우 전달된 결제 완료 후 응답 파라미터 처리

                        console.log(rsp);
                    });
                },
                error  : function () {
                    alert("에러 발생");
                },
            });
        }
    </script>
</head>
<body>
<h1>결제요청</h1>
<div id="paymentInfo">
    <textarea id="paymentInfo_result" cols="75" rows="4"></textarea>
</div>
<table class="info_tbl" summary="충전제 요금 안내표입니다.">
    <tr>
        <th>상품 선택</th>
        <td>
            <select id="productTypeSelect">
                <option value="-" name="">기본</option>
            </select>
        </td>
    </tr>
    <tr>
        <th>시작일</th>
        <td><input readonly="readonly" type="text" id="startDate" name="startDate" value=""></td>
    </tr>
    <tr>
        <th>종료일</th>
        <td><input readonly="readonly" type="text" id="endDate" name="endDate" value=""></td>
    </tr>
    <tr>
        <th>제공 건수</th>
        <td><input readonly="readonly" type="text" id="offer" name="offer" value=""></td>
    </tr>
    <tr>
        <th>결제 금액</th>
        <td><input readonly="readonly" type="text" id="price" name="price" value=""></td>
    </tr>
    <tr>
        <td>
            <div style="display: flex; height: 500px" id="vbank_proc">
                <div style="display: inline-flex; flex-direction: column; height: 100%;">
                    <button onclick="pay('vbank')" style="flex:auto">무통장 입금</button>
                    <textarea id="pay_result" cols="75" rows="30"></textarea>
                </div>
            </div>
        </td>
        <td>
            <div style="display: flex; height: 500px" id="card_proc">
                <div style="display: inline-flex; flex-direction: column; height: 100%;">
                    <button onclick="pay('card')" style="flex:auto">신용카드 결제 요청</button>
                    <textarea id="pay_result" cols="75" rows="30"></textarea>
                </div>
            </div>
        </td>
    </tr>
</table>


<script>

</script>
</body>
</html>
